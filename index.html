<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>reveal.js</title>

    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/reveal.css" />
    <link rel="stylesheet" href="dist/theme/black.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" />
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <img data-src="dist/images/overview/intro.jpg" style="height: 400px" />
          <h2>DB 적재 관련 기술공유</h2>
          <p>
            <small
              >Created by 동훈@<a href="http://all4land.com/" target="_blank">올포랜드</a>
            </small>
          </p>
        </section>

        <section>
          <h2>목차</h2>
          <ol>
            <li>개요</li>
            <li>SCP로 원격 호스트간 파일 이동</li>
            <li>PSQL을 이용한 SQL 쿼리</li>
            <li>변환 및 적재 프로그램</li>
          </ol>
        </section>

        <section data-transition="slide" data-background="#89B640">
          <h2>개요</h2>
        </section>

        <section data-transition="slide" data-background="#89B640">
          <h4>알아야 할 것들</h4>
          <ul>
            <li style="font-size: 30px">SSH - 원격 호스트 접속 프로그램</li>
            <li style="font-size: 30px">SCP - 원격 호스트 간 파일 이동 프로그램</li>
            <li style="font-size: 30px">
              PSQL - 대화형 PostgreSQL 프로그램(적재 및 SQL 쿼리 실행)
            </li>
            <li style="font-size: 30px">
              파이썬 가상환경(virtualenv) - netCDF 파일을 변환하고 DB에 적재하는데 필요한 파이썬
              라이브러리가 다른 프로젝트랑 꼬이지 않도록 관리 해주는 환경
            </li>
          </ul>
        </section>

        <section data-transition="slide" data-background="#89B640">
          <h4>DB 설계도 - 전체</h4>
          <img data-src="dist/images/overview/erd_1.png" />
        </section>

        <section data-transition="slide" data-background="#89B640">
          <h4>DB 설계도 - 위험사례 재현정보</h4>
          <img data-src="dist/images/overview/erd_2.png" />
        </section>

        <section data-transition="slide" data-background="#89B640">
          <h4>DB 적재 순서도</h4>
          <img data-src="dist/images/overview/flowchart.png" />
          <ol>
            <li style="font-size: 20px">
              보시다시피 변환 및 적재 프로그램을 실행하기에 앞서 먼저 원격 호스트 서버 간 netCDF
              파일들을 복사 이동해야한다. (all4ocean -> hils) 따라서, 먼저 SCP 프로그램을 이용해
              파일을 복사 이동하는 방법에 대해 알아볼 것이다.
            </li>
            <li style="font-size: 20px">
              그 다음, 데이터를 데이터베이스에 적재하기 위해 알아야할 PSQL 프로그램 사용법에 대해서
              간단히 알아볼 것이다.
            </li>
            <li style="font-size: 20px">
              최종적으로, 파이썬 기반의 변환 및 적재 프로그램 실행법에 대해서 알아볼 것이다.
            </li>
          </ol>
        </section>

        <section data-transition="slide" data-background="#4d7e65">
          <h2>SCP로 원격 호스트간 파일 이동</h2>
          <p></p>
        </section>

        <section data-transition="slide" data-background="#4d7e65">
          <h4>SCP란?</h4>
          <p>
            <small
              >데이터를 DB에 적재하기에 앞서 all4ocean 원격 호스트 서버에 위치한 netCDF 파일들을
              DB가 위치한 hils 원격 호스트 서버로 복사해야 한다. 하드 드라이버에 옮겨서 두 번
              이동하는거 보다 훨씬 효율적이다.</small
            >
          </p>
          <img data-src="dist/images/scp/scp_1.png" />
        </section>

        <section data-transition="slide" data-background="#4d7e65">
          <h4>SCP 문법</h4>
          <pre><code class="hljs sh" data-trim>
            scp [SOURCE] [TARGET] [OPTIONS]
          </code></pre>
          <ul>
            <li style="font-size: 20px">
              scp는 두 개의 위치 간에 파일 및 디렉터리를 안전하게 copy 하도록 도와주는 커맨드 라인
              유틸리티 프로그램이다.
            </li>
            <li style="font-size: 20px">
              SOURCE와 TARGET으로 로컬 경로를 지정하거나 [username@]host:[path] 형식으로 원격
              호스트의 경로를 지정할 수 있다.
            </li>
            <ul>
              <li style="font-size: 20px">
                SOURCE는 우리가 복사해서 가져올 파일 또는 디렉터리 경로
              </li>
              <li style="font-size: 20px">
                TARGET은 우리가 복사한 것을 갔다 붙혀넣을 파일 또는 디렉터리 경로
              </li>
            </ul>
            <li style="font-size: 20px">
              OPTIONS은 너무 많은데, 우리가 꼭 알아야 할 것은 -P와 -r 옵션이다.
            </li>
            <ul>
              <li style="font-size: 20px">-P - 원격 호스트에 연결할 포트번호 지정</li>
              <li style="font-size: 20px">
                -r - 하위 디렉터리를 포함한 모든 디텍토리를 재귀적으로(recursively) 복사
              </li>
            </ul>
          </ul>
        </section>

        <section data-transition="slide" data-background="#4d7e65">
          <h4>SCP 예시</h4>
          <pre><code class="hljs sh" data-trim data-line-numbers="1-2|4-7"><script type="text/template" >
            # ssh [user@]hostname [command]
            ssh ppark@211.178.39.246 -p 12522

            # scp [SOURCE] [TARGET] [OPTIONS]
            scp -r -P 7001 \
            opr@211.178.39.246:/home/opr/jspark/00_PROJECT/2022y/02_1MW/01_rawdata/04_interm/03_HYCOM/01_typhoon/20110626 \
            /home/ppark/projects/hilsdb/data/cases_hindcasts/typhoons
          </script></code></pre>
          <ul>
            <li style="font-size: 20px">
              먼저 ssh로 hils 원격 호스트 서버에 접속한 다음에 scp로 다른 원격 호스트 서버인
              all4ocean에 위치한 netCDF 파일을 가져와 보자. 따라서, SOURCE는 [username@]host:[path]
              형식가 되는데 TARGET은 이미 hils에 접속한 상태이므로 로컬 경로 형식이 된다.
            </li>
            <li style="font-size: 20px">
              반대로 all4ocean에 접속해서 할 수도 있다. 그러면 SOURCE가 로컬 경로 형식이고 TARGET이
              [username@]host:[path] 형식이 된다.
            </li>
            <li style="font-size: 20px">
              ssh는 일반적으로 원격 호스트에 로그인하고 명령을 실행하는 데 사용된다.
            </li>
          </ul>
        </section>

        <section data-transition="slide" data-background="#4d7e65">
          <h4>SCP 예시</h4>
          <img data-src="dist/images/scp/scp_2.jpg" />
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h2>PSQL을 이용한 SQL 쿼리</h2>
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>원격 서버 데이터베이스 접근</h4>
          <pre><code class="hljs sh" data-trim data-line-numbers="1-2|4-5">
            # ssh [user@]hostname [command]
            ssh ppark@211.178.39.246 -p 12522

            # psql -h {호스트명} -p {포트번호} -U {사용자명} -d {데이터베이스명}
            psql -h localhost -p 5432 -U postgres -d hils
          </code></pre>
          <ul>
            <li style="font-size: 20px">
              보안상 원격 서버의 데이터베이스에 바로 접근하지 않고, 우선 ssh로 원격 서버에 접근한
              다음에 데이터베이스에 접근하는 것이 국룰이다.
            </li>
            <li style="font-size: 20px">
              ssh는 일반적으로 원격 시스템에 로그인하고 명령을 실행하는 데 사용된다. 터널링 및 포트
              포워딩에도 사용된다.
            </li>
            <li style="font-size: 20px">
              psql은 PostgreSQL 대화형 터미널 프로그램으로 대화형으로 SQL 명령을 편집/실행 할 수
              있다.
            </li>
          </ul>
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>유용한 psql 커맨드</h4>
          <pre><code class="hljs SQL" data-trim data-line-numbers="1-2|4-5|7-8|10-11|13-14|16-17">
            -- 모든 데이터베이스 목록보기 
            \l

            -- 모든 스키마 목록보기
            \dn

            -- 모든 테이블 목록보기
            \dt

            -- 특정 스키마 내의 모든 테이블 목록보기
            \dt {schema_name}.*

            -- psql 스크린 클리어하기
            \! clear

            -- psql 커맨드라인 세션 종료하기
            \q
          </code></pre>
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>모든 카테고리 조회</h4>
          <pre><code class="hljs SQL" data-trim>
            SELECT * FROM cases_hindcasts.categories;
          </code></pre>
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>모든 카테고리 조회</h4>
          <img data-src="dist/images/sql/sql_query_1.jpg" />
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>데이터셋별 모든 변수 조회</h4>
          <pre><code class="hljs SQL" data-trim>
            -- 데이터셋 식별자가 1에 해당하는 모든 변수 조회
            SELECT
                variables.var_id,
                variables.var_name,
                variables.var_long_name,
                variables.var_standard_name,
                variables.var_units,
                variables.dataset_id
            FROM cases_hindcasts.variables
            INNER JOIN cases_hindcasts.datasets ON
                datasets.dataset_id = variables.dataset_id
            WHERE 
                datasets.dataset_id = 1;
          </code></pre>
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>데이터셋별 모든 변수 조회</h4>
          <img data-src="dist/images/sql/sql_query_2.jpg" />
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>카테고리별 모든 데이터셋 조회</h4>
          <pre><code class="hljs SQL" data-trim>
            -- 태풍 카테고리에 해당하는 모든 데이터셋 조회
            SELECT
                datasets.dataset_id,
                datasets.dataset_name,
                datasets.category_id,
                datasets.time_start,
                datasets.time_end
            FROM cases_hindcasts.datasets
            INNER JOIN cases_hindcasts.categories
                ON categories.category_id = datasets.category_id
            WHERE
                category_name=COALESCE(NULL, 'typhoon');
          </code></pre>
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>카테고리별 모든 데이터셋 조회</h4>
          <img data-src="dist/images/sql/sql_query_3.jpg" />
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>연도별 모든 데이터셋 조회</h4>
          <pre><code class="hljs SQL" data-trim>
            -- 2021년에 해당하는 모든 데이터셋 조회
            SELECT
                dataset_id,
                dataset_name,
                datasets.time_start,
                datasets.time_end
            FROM cases_hindcasts.datasets
            WHERE 
                EXTRACT(year FROM time_start) = 2012 OR 
                EXTRACT(year FROM time_end) = 2012;
          </code></pre>
        </section>

        <section data-transition="slide" data-background="#0064a5">
          <h4>연도별 모든 데이터셋 조회</h4>
          <img data-src="dist/images/sql/sql_query_4.jpg" />
        </section>

        <section data-transition="slide" data-background="#008bb9">
          <h2>변환 및 적재 프로그램</h2>
        </section>
      </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,
        slideNumber: 'c/t',

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
      });
    </script>
  </body>
</html>
